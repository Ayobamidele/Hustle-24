{% extends 'shop/main.html' %}

{% block content %}	

	<div class="container my-5">
		<div class="row">
			<div class="col text-center h1">
		  		<h1 class="h1">Checkout</h1>
			</div>
	  	</div>
	</div>

	<section class="no-overflow pt-0">
		<div class="container">
	  		<div class="row gutter-4 justify-content-between">
				<form id="regform" class="d-flex mx-auto" action="" method="POST" enctype="multipart/form-data">
					<div id="reg"  class="row align-items-end mb-2 col-lg-8">
						{% csrf_token %}	
						<!-- personal details -->
						<div class="row align-items-end mb-2">
							<div class="col-md-12">
								<h2 class="h3 mb-0"><span class="text-muted">01.</span> Personal Details</h2>
							</div>
							
						</div>
						<div class="row gutter-1 mb-6">
							<div class="form-group col-md-6">
								<label for="firstName">First Name</label>
								{{ regform.first_name }}
								<!-- <input type="text" class="form-control" id="firstName" placeholder=""> -->
							</div>
							<div class="form-group col-md-6">
								<label for="lastName">Last Name</label>
								{{ regform.last_name }}
								<!-- <input type="text" class="form-control" id="lastName" placeholder=""> -->
							</div>
							<div class="form-group col-md-6">
								<label for="email">Email</label>
								{{ regform.email }}
								<!-- <input type="text" class="form-control" id="companyName" placeholder=""> -->
							</div>
							<div class="form-group col-md-6">
								<label for="password2">Password</label>
								{{ regform.password1 }}
								<!-- <input type="text" class="form-control" id="country" placeholder=""> -->
							</div>
							
						</div>

						<!-- delivery address -->
						<div class="row align-items-end mb-2">
							<div class="col-md-12">
								<h2 class="h3 mb-0"><span class="text-muted">02.</span> Delivery Address</h2>
							</div>
						</div>
						<div class="row gutter-1 mb-6">
							<div class="form-group col-md-8">
								<label for="address">Address</label>
								<input type="text" class="form-control" id="address" name="address" placeholder="">
							</div>
							<div class="form-group col-md-4">
								<label for="city">City</label>
								<input type="text" class="form-control" id="city" name="city" placeholder="">
							</div>
							<div class="form-group col-md-4">
								<label for="state">State</label>
								<input type="text" class="form-control" id="state" name="state" placeholder="">
							</div>
							<div class="form-group col-md-4">
								<label for="postcode">Zipcode</label>
								<input type="text" class="form-control" id="zipcode" name="zipcode" placeholder="">
							</div>
							<div class="form-group col-md-4">
								<label for="country">Country</label>
								<input type="text" class="form-control" id="country" name="country" placeholder="">
							</div>
						</div>

						<!-- payment -->
						<div class="row align-items-end mb-2">
							<div class="col-md-12">
								<h2 class="h3 mb-0"><span class="text-muted">03.</span> Payment</h2>
							</div>
						</div>
						<div class="row gutter-1 mb-6">
							<div class="col-12 pb-1">
								<ul class="nav nav-tabs lavalamp" id="myTab" role="tablist">
									<li class="nav-item">
										<a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Credit Card</a>
									</li>
									<!-- <li class="nav-item">
										<a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">PayPal</a>
									</li> -->
								</ul>
							</div>
							<div class="col-12">
								<div class="tab-content" id="myTabContent">
									<div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
										<div class="row gutter-1">
											<div class="form-group col-12">
												<div class="d-flex eyebrow">
													<div class="input-group-prepend">
														<span class="input-group-text" id="basic-addon1"><i class="icon-credit-card"></i></span>
													</div>
													<input type="tel" id="id_card_number" class="form-control eyebrow" placeholder="Card Number" name="card_number" aria-label="Username" aria-describedby="basic-addon1">
												</div>
											</div>
											<div class="form-group col-md-6">
												<label for="nameOnCard">Name on Card</label>
												<input type="text" class="form-control" id="nameOnCard" name="name_on_card" placeholder="">
											</div>
											<div class="form-group col-md-3">
												<label for="month">Month</label>
												<input type="date" class="form-control" name="date" id="month">
											</div>
											<div class="form-group col-md-3">
												<label for="cvv">CVV</label>
												<input type="password" class="form-control" id="cvv" name="cvv" placeholder="">
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

					</div>
					<aside class="col-lg-4" id="orderDetails">
						<div class="row">

							<div class="col-12 mb-1" id="loginOpt">
								<div class=" d-flex bg-light p-3">
									<div class="col-8 pr-0">
										<h3 class="small">Already have an account?</h3>
									</div>
									<div class="col-4 text-right my-auto pl-0">
										<a href="{% url 'login' %}" class="underline eyebrow ml-2">Sign-In</a>
									</div>
								</div>
							</div>
							<!-- order preview -->
							<div class="col-12">
								<div class="card card-data bg-light">
									<div class="card-header py-2 px-3">
										<div class="row align-items-center p-2">
											<div class="col">
												<h3 class="fs-18 mb-0">Your Cart</h3>
											</div>
											<div class="col text-right">
												<a href="{% url 'cart' %}" class="underline eyebrow">Edit</a>
											</div>
										</div>
									</div>
									<div class="card-body">
										<ul class="list-group list-group-line">
											{% for item in items %}
												<li class="list-group-item d-flex justify-content-between text-dark align-items-center">
													{{ item.product.title }} x{{ item.quantity }}
												<span>${{ item.get_total }}</span>
												</li>
											{% endfor %}
										</ul>
									</div>
								</div>
							</div>

							<!-- order summary -->
							<div class="col-12 mt-1">
								<div class="card card-data bg-light">
									<div class="card-header py-2 px-3">
										<div class="row align-items-center p-2">
											<div class="col">
												<h3 class="fs-18 mb-0">Order Summary</h3>
											</div>
										</div>
									</div>
									
									<div class="card-body">
										<ul class="list-group list-group-minimal">
											<li class="list-group-item d-flex justify-content-between align-items-center py-1">
												Subtotal<span>${{order.get_cart_total}}</span>
											</li>
											<!-- <li class="list-group-item d-flex justify-content-between align-items-center py-1">
												Shipping<span>Free</span>
											</li> -->
											<!-- <li class="list-group-item d-flex justify-content-between align-items-center">
											Discount
											<span>-25%</span>
											</li> -->
										</ul>
									</div>
									<div class="card-footer py-1">
										<ul class="list-group list-group-minimal">
											<li class="list-group-item d-flex justify-content-between align-items-center text-dark fs-18">
												Total<span>${{order.get_cart_total}}</span>
											</li>
										</ul>
									</div>
								</div>
							</div>

							<!-- place order -->
							<div class="col-12 mt-1 eyebrow">
								<a href="#!" onclick="submitFormData()" class="btn btn-primary btn-lg btn-block eyebrow">Place Order</a>
							</div>

						</div>
					</aside>
				</form>
			</div>
		</div>
	</section>
	<script>
		var regForm = document.getElementById("reg")
		var orderDetails = document.getElementById("orderDetails")
		var creditCardInput = document.getElementById("id_card_number");
		var loginOpt = document.getElementById("loginOpt");

		function display_register() {
			if (user !== 'AnonymousUser') {
				regForm.remove()
				loginOpt.remove()
				orderDetails.classList.remove("col-lg-4")
				orderDetails.classList.add("col-lg-12")
			}
		}
			
		var disp = display_register();
		var form = document.getElementById('regform')
		function submitFormData(){
			
			var shippingInfo = {
				'address':null,
				'city':null,
				'state':null,
				'zipcode':null,
				'country':null,

				'card_number':null,
				'name_on_card':null,
				'year':null,
				'month':null,
				'cvv':null,
			}
			var userFormData = {
				"first_name":null,
				"last_name":null,
				"email":null,
				"password":null,
			}
			if(user == 'AnonymousUser'){
				userFormData.first_name = form.first_name.value
				userFormData.last_name = form.last_name.value
				userFormData.email = form.email.value
				userFormData.password = form.password.value

				shippingInfo.address = form.address.value
				shippingInfo.city = form.city.value
				shippingInfo.state = form.state.value
				shippingInfo.zipcode = form.zipcode.value
				shippingInfo.country = form.country.value

				shippingInfo.card_number = form.card_number.value
				shippingInfo.name_on_card = form.name_on_card.value
				shippingInfo.month = form.valueAsDate.getMonth() + 1
				shippingInfo.year = form.valueAsDate.getFullYear()
				shippingInfo.cvv = form.cvv.value
			}
			var url = "/cart/process-order";
			fetch(url, {
				method :'POST',
				headers:{
					"Content-Type":"application/json",
					"X-CSRFToken":csrftoken,
				},
				body: JSON.stringify({"form": userFormData})
			})
			.then((response) => response.json())
			.then((data) => {
				console.log('Success:', data);
				alert('Transaction completed');
				cart = {}
				document.cookie ="cart=" + JSON.stringify(cart) + ";domain=; path=/"
				window.location.href = "{% url 'home' %}"
			})
		}
		
		creditCardInput.onkeydown = function(e) {
			var cursor = this.selectionStart;
			if (this.selectionEnd != cursor) return;
		
			if (e.which == 46) {
				if (this.value[cursor] == " ") this.selectionStart++;
			} else if (e.which == 8) {
				if (cursor && this.value[cursor - 1] == " ") this.selectionEnd--;
			}
		
		}.oninput = function() {
			var value = this.value;
			var cursor = this.selectionStart;
		
			var matches = value.substring(0, cursor).match(/[^0-9]/g);
		
			if (matches) cursor -= matches.length;
			value = value.replace(/[^0-9]/g, "").substring(0, 24);
			var formatted = "";
			for (var i=0, n=value.length; i<n; i++) {
				if (i && i % 4 == 0) {
					if (formatted.length <= cursor) cursor++;
					formatted += " ";
				}
				formatted += value[i];
			}
			if (formatted == this.value) return;
		
			this.value = formatted;
			this.selectionEnd = cursor;
		};
	</script>
{% endblock %}